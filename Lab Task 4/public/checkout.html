<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout - BeCleaner</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <style>
    .checkout-wrapper { padding: 28px 0 60px; min-height: 100vh }
    .checkout-container { max-width: 1100px; margin: 0 auto }
    .checkout-btn { width: 100%; padding: 12px; border-radius: 10px; font-weight: 800 }
    .invalid-feedback { display: block }
  </style>
</head>

<body>

<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="index"><span class="be">Be</span><span class="cleaner">cleaner</span></a>
    <nav class="header-nav">
      <a href="/">Home</a>
      <a href="contact">Contact</a>
    </nav>
  </div>
</header>

<main class="checkout-wrapper">
  <div class="container checkout-container">

    <h2>Checkout</h2>
    <div class="row g-4">

      <!-- FORM COLUMN -->
      <div class="col-12 col-lg-7">
        <div class="card-muted p-4">

          <form id="checkout-form">

            <h4>Customer Details</h4>

            <div class="mb-3">
              <label for="serviceSelect" class="form-label">Select service</label>
              <select id="serviceSelect" name="service" class="form-select" required>
                <option value="">Choose...</option>
                <option value="Standard Home Cleaning" data-price="49">Standard Home Cleaning — $49</option>
                <option value="Deep Cleaning" data-price="99">Deep Cleaning — $99</option>
                <option value="Office Cleaning" data-price="79">Office Cleaning — $79</option>
              </select>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <label class="form-label">Full Name</label>
                <input id="fullName" name="fullName" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label>Email</label>
                <input id="email" name="email" type="email" class="form-control" required>
              </div>

              <div class="col-md-6">
                <label>Phone</label>
                <input id="phone" name="phone" class="form-control" required>
              </div>

              <div class="col-12">
                <label>Address</label>
                <input id="address" name="address" class="form-control" required>
              </div>

              <div class="col-md-4">
                <label>City</label>
                <input id="city" name="city" class="form-control" required>
              </div>

              <div class="col-md-4">
                <label>Postal Code</label>
                <input id="postal" name="postal" class="form-control" required>
              </div>

              <div class="col-md-4">
                <label>Country</label>
                <select id="country" name="country" class="form-select" required>
                  <option value="">Choose...</option>
                  <option>United States</option>
                  <option>Canada</option>
                  <option>United Kingdom</option>
                  <option>Australia</option>
                </select>
              </div>

            </div>

            <hr>

            <h5>Add-ons</h5>

            <div>
              <input type="checkbox" class="addon" id="addonWindow" data-price="15">
              <label for="addonWindow">Window add-on — $15</label>
            </div>

            <div>
              <input type="checkbox" class="addon" id="addonFridge" data-price="25">
              <label for="addonFridge">Fridge interior — $25</label>
            </div>

            <hr>

            <div class="row g-3">
              <div class="col-md-6">
                <label for="date" class="form-label">Preferred date</label>
                <input type="date" id="date" name="date" class="form-control" required>
              </div>
              <div class="col-md-6">
                <label for="time" class="form-label">Preferred time</label>
                <input type="time" id="time" name="time" class="form-control" required>
              </div>
            </div>

            <hr>

            <h5>Payment</h5>

            <div class="form-check">
              <input type="radio" name="paymentMethod" id="pay-card" value="card" checked class="form-check-input">
              <label for="pay-card" class="form-check-label">Card</label>
            </div>

            <div class="form-check">
              <input type="radio" name="paymentMethod" id="pay-cod" value="cod" class="form-check-input">
              <label for="pay-cod" class="form-check-label">Cash on Delivery</label>
            </div>

            <hr>

            <div class="form-check">
              <input type="checkbox" id="agreeTerms" class="form-check-input">
              <label for="agreeTerms" class="form-check-label">I agree to the terms</label>
            </div>

            <button id="placeOrderBtn" type="button" class="checkout-btn btn btn-primary mt-3" disabled>
              Place Order
            </button>

          </form>

        </div>
      </div>

      <!-- ORDER SUMMARY -->
      <aside class="col-12 col-lg-5">
        <div class="p-3 border rounded">
          <h4>Order Summary</h4>
          <div id="itemsList"><small>No items selected</small></div>

          <div class="mt-3">
            <div class="d-flex justify-content-between">
              <span>Subtotal</span><span id="subtotal">$0.00</span>
            </div>
            <div class="d-flex justify-content-between">
              <span>Shipping</span><span>$5.00</span>
            </div>
            <div class="d-flex justify-content-between fw-bold mt-2">
              <span>Total</span><span id="grandTotal">$0.00</span>
            </div>
          </div>

        </div>
      </aside>

    </div>
  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
  const placeBtn = $("#placeOrderBtn");
  const agree = $("#agreeTerms");

  agree.on("change", () => {
    placeBtn.prop("disabled", !agree.prop("checked"));
  });

  // ------------------ ORDER SUMMARY -------------------
  function updateSummary() {
    const serviceOption = $("#serviceSelect option:selected");
    let subtotal = 0;
    let items = [];

    if (serviceOption.val() !== "") {
      const price = Number(serviceOption.data("price"));
      subtotal += price;
      items.push({ name: serviceOption.val(), price });
    }

    $(".addon").each(function () {
      if (this.checked) {
        const label = $(this).next("label").text();
        const price = Number($(this).data("price"));
        subtotal += price;
        items.push({ name: label, price });
      }
    });

    $("#itemsList").html(
      items.length === 0
        ? "<small>No items selected</small>"
        : items.map(i => `<div>${i.name} — $${i.price}</div>`).join("")
    );

    const total = subtotal + 5;
    $("#subtotal").text("$" + subtotal.toFixed(2));
    $("#grandTotal").text("$" + total.toFixed(2));
  }

  $("#serviceSelect, .addon, #date, #time").on("change input", updateSummary);
  updateSummary();

  // ------------------ SEND BOOKING -------------------
  placeBtn.on("click", function () {

    const formData = {
      service: $("#serviceSelect").val(),
      addons: $(".addon:checked").map(function () { return $(this).next("label").text(); }).get(),
      fullName: $("#fullName").val(),
      email: $("#email").val(),
      phone: $("#phone").val(),
      address: $("#address").val(),
      city: $("#city").val(),
      postal: $("#postal").val(),
      country: $("#country").val(),
      date: $("#date").val(),
      time: $("#time").val(),
      paymentMethod: $("input[name='paymentMethod']:checked").val(),
      total: $("#grandTotal").text()
    };

    placeBtn.text("Placing...");
    placeBtn.prop("disabled", true);

    $.post("/api/bookings/create", formData)
      .done(res => {
        window.location.href = "success";
      })
      .fail(() => {
        alert("Error saving booking");
        placeBtn.text("Place Order");
        placeBtn.prop("disabled", false);
      });
  });
</script>

</body>
</html>
