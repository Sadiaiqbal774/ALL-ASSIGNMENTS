<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manage Bookings — CRUD</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background:#f8fafc; }
    .crud-wrapper { padding: 28px 0 72px; }
    .crud-card { border-radius: 12px; background:#fff; padding: 18px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    .list-row { display:flex; justify-content:space-between; padding:10px 6px; border-bottom:1px solid rgba(0,0,0,0.05); }
    .list-row .meta { font-size:.9rem; color:#6b7280; }
    .muted-small { color:#6b7280; font-size:.9rem; }
    .btn-ghost { background:transparent; border:1px solid #d0d0d0; }
    .empty-note { padding:18px; text-align:center; color:#6b7280; }
    .crud-grid { display:grid; grid-template-columns:1fr 420px; gap:24px; }
    @media(max-width:900px){ .crud-grid { grid-template-columns:1fr; } }
    .field-error { color:#d04848; font-size:.9rem; display:none; }
    .is-invalid { border-color:#d04848; }
  </style>
</head>

<body>

<header class="p-3 bg-white border-bottom">
  <div class="container d-flex justify-content-between">
    <h4 class="m-0">BeCleaner – CRUD</h4>
    <nav>
      <a href="/" class="me-3">Home</a>
      <a href="/checkout">Checkout</a>
    </nav>
  </div>
</header>

<main class="crud-wrapper">
  <div class="container">

    <div class="crud-grid">

      <!-- FORM CARD -->
      <section class="crud-card">
        <h5 id="formTitle">Create booking</h5>

        <form id="crud-form" autocomplete="off">
          <input type="hidden" id="editId" />

          <div class="mb-3">
            <label class="form-label">Service</label>
            <select id="service" class="form-select" required>
              <option value="">Choose…</option>
              <option value="Standard Home Cleaning">Standard Home Cleaning</option>
              <option value="Deep Cleaning">Deep Cleaning</option>
              <option value="Office Cleaning">Office Cleaning</option>
            </select>
            <div class="field-error" data-for="service">Please pick a service.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Full name</label>
            <input id="name" type="text" class="form-control" required>
            <div class="field-error" data-for="name">Enter a valid name.</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input id="email" type="email" class="form-control" required>
              <div class="field-error" data-for="email">Enter a valid email.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Phone</label>
              <input id="phone" type="text" class="form-control" required>
              <div class="field-error" data-for="phone">Enter phone number.</div>
            </div>

            <div class="col-12">
              <label class="form-label">Address</label>
              <input id="address" type="text" class="form-control" required>
              <div class="field-error" data-for="address">Enter address.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Date</label>
              <input id="date" type="date" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Time</label>
              <input id="time" type="time" class="form-control" required>
            </div>
          </div>

          <div class="d-flex mt-3">
            <button type="button" id="saveBtn" class="btn btn-primary">Save</button>
            <button type="button" id="cancelBtn" class="btn btn-secondary ms-2">Cancel</button>
            <div id="formStatus" class="ms-auto muted-small"></div>
          </div>

        </form>
      </section>

      <!-- LIST CARD -->
      <aside class="crud-card">
        <div class="d-flex align-items-center mb-3">
          <h5 class="m-0">Bookings</h5>
          <input id="search" class="form-control form-control-sm ms-auto" placeholder="Search…">
          <button id="refreshBtn" class="btn btn-sm btn-ghost ms-2">Refresh</button>
        </div>

        <div id="listContainer" style="min-height:140px;">
          <div class="empty-note">No bookings yet.</div>
        </div>

        <div class="mt-2 muted-small">Showing <span id="count">0</span> item(s)</div>

      </aside>

    </div>

  </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>

  const API = "http://localhost:3000/api/bookings";
  let bookings = [];

  const $list = $('#listContainer');
  const $count = $('#count');

  function validate() {
    let ok = true;
    const fields = [
      { id: '#service', key: "service" },
      { id: '#name', key: "name" },
      { id: '#email', key: "email" },
      { id: '#phone', key: "phone" },
      { id: '#address', key: "address" },
      { id: '#date', key: "date" },
      { id: '#time', key: "time" }
    ];

    $(".field-error").hide();
    $("input,select").removeClass("is-invalid");

    fields.forEach(f => {
      let val = $(f.id).val();
      if (!val) {
        ok = false;
        $(f.id).addClass("is-invalid");
        $(`.field-error[data-for="${f.key}"]`).show();
      }
    });

    return ok;
  }

  function renderList(filter = "") {
    $list.empty();
    const t = filter.toLowerCase();

    let filtered = bookings.filter(b =>
      (b.name || "").toLowerCase().includes(t) ||
      (b.service || "").toLowerCase().includes(t)
    );

    if (!filtered.length) {
      $list.html('<div class="empty-note">No bookings found.</div>');
      $count.text(0);
      return;
    }

    filtered.forEach(b => {
      const row = $(`
        <div class="list-row">
          <div>
            <div class="fw-semibold">${b.name}</div>
            <div class="meta">${b.service}</div>
            <div class="meta">${b.date} ${b.time}</div>
          </div>
          <div class="d-flex">
            <button class="btn btn-sm btn-outline-primary me-2 editBtn">Edit</button>
            <button class="btn btn-sm btn-outline-danger deleteBtn">Delete</button>
          </div>
        </div>
      `);

      row.find(".editBtn").click(() => populateForm(b));
      row.find(".deleteBtn").click(() => deleteBooking(b._id));

      $list.append(row);
    });

    $count.text(filtered.length);
  }

  function populateForm(b) {
    $("#editId").val(b._id);
    $("#formTitle").text("Edit booking");

    $("#service").val(b.service);
    $("#name").val(b.name);
    $("#email").val(b.email);
    $("#phone").val(b.phone);
    $("#address").val(b.address);
    $("#date").val(b.date);
    $("#time").val(b.time);
  }

  function resetForm() {
    $("#crud-form")[0].reset();
    $("#editId").val("");
    $("#formTitle").text("Create booking");
    $("input,select").removeClass("is-invalid");
    $(".field-error").hide();
  }

  async function saveBooking() {
    if (!validate()) return;

    const payload = {
      service: $("#service").val(),
      name: $("#name").val(),
      email: $("#email").val(),
      phone: $("#phone").val(),
      address: $("#address").val(),
      date: $("#date").val(),
      time: $("#time").val()
    };

    const id = $("#editId").val();
    const url = id ? `${API}/update/${id}` : `${API}/create`;
    const method = id ? "PUT" : "POST";

    const res = await fetch(url, {
      method,
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) return alert("Error saving booking");

    if (id) {
      bookings = bookings.map(b => b._id === data._id ? data : b);
    } else {
      bookings.unshift(data.booking);
    }

    resetForm();
    renderList($("#search").val());
  }

  async function deleteBooking(id) {
    if (!confirm("Delete booking?")) return;

    await fetch(`${API}/delete/${id}`, { method: "DELETE" });

    bookings = bookings.filter(b => b._id !== id);
    renderList($("#search").val());
  }

  async function loadBookings() {
    const res = await fetch(`${API}/all`);
    bookings = await res.json();
    renderList($("#search").val());
  }

  $("#saveBtn").click(saveBooking);
  $("#cancelBtn").click(resetForm);
  $("#search").on("input", () => renderList($("#search").val()));
  $("#refreshBtn").click(loadBookings);

  $(document).ready(loadBookings);
</script>

</body>
</html>
